<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pendientes</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Tailwind para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <!-- Importación de Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el checkbox 'chulado' */
        .task-completed label,
        .task-completed span { /* Aplicar también a la fecha de vencimiento */
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        /* Animación simple de carga */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Estilos para el input de archivo */
        .file-input::file-selector-button {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border-width: 0;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
            cursor: pointer;
        }
        .file-input::file-selector-button:hover {
            background-color: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">

        <!-- Título y ID de Usuario -->
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-4 text-blue-400">Gestor de Pendientes</h1>
        <p id="userIdDisplay" class="text-xs text-gray-500 text-center mb-6 break-all"></p>

        <!-- Contenedor de Login -->
        <div id="loginContainer" class="bg-gray-800 p-8 rounded-xl shadow-2xl space-y-6 max-w-sm mx-auto my-10" style="display: none;">
            <h2 class="text-2xl font-bold text-center text-white">Acceso Restringido</h2>
            <p class="text-sm text-gray-400 text-center">Solo las cuentas autorizadas pueden ingresar.</p>
            
            <form id="loginForm" class="space-y-4">
                <input type="email" id="emailInput"
                       class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Correo electrónico" required>
                <input type="password" id="passwordInput"
                       class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Contraseña" required>
                <button type="submit" id="loginButton"
                        class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition duration-200">
                    Ingresar
                </button>
                <p id="loginMessage" class="text-sm text-red-400 text-center" style="display: none;"></p>
            </form>
        </div>

        <!-- Contenedor Principal de la App (Oculto hasta el login) -->
        <div id="appContainer" style="display: none;">
            <!-- Formulario para agregar nuevos pendientes -->
            <form id="addTaskForm" class="flex flex-col sm:flex-row gap-3 mb-8">
                <input type="text" id="taskInput"
                       class="flex-grow bg-gray-800 border border-gray-700 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                       placeholder="Agregar un nuevo pendiente..." required>
                <input type="date" id="dueDateInput"
                       title="Fecha de cumplimiento"
                       class="bg-gray-800 border border-gray-700 text-gray-400 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full sm:w-auto p-2.5">
                <button type="submit"
                        class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    Agregar
                </button>
            </form>

            <!-- Contenedor de la lista de pendientes -->
            <div id="loading" class="flex flex-col items-center justify-center py-10">
                <div class="spinner"></div>
                <p class="mt-4 text-gray-400">Cargando...</p>
            </div>

            <div id="taskList" class="space-y-4">
                <!-- Las tareas se renderizarán aquí desde JavaScript -->
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            arrayUnion,
            getDocs,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Importar Firebase Storage
        import { 
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Configuración de Firebase (Asegúrate que sea la correcta de tu proyecto) ---
        const firebaseConfig = {
          apiKey: "AIzaSyA5721oMTw-b-1j_CtvhjwQJQcS6812WWw", // <-- Verifica si esta es la API key correcta
          authDomain: "pendientes-55b47.firebaseapp.com",
          projectId: "pendientes-55b47",
          storageBucket: "pendientes-55b47.firebasestorage.app",
          messagingSenderId: "637191435019",
          appId: "1:637191435019:web:d9b833365738cff641680e"
        };

        // Definimos el ID del proyecto para las rutas de Firestore/Storage
        const appId = firebaseConfig.projectId; 

        let app, db, auth, storage, currentUserId, tasksCollectionRef;

        // --- CONSTANTES DE AUTORIZACIÓN ---
        const ALLOWED_EMAILS = [
            'instructor.andrade.dcc@gmail.com',
            'ivandariomejia1987@gmail.com'
        ];
        
        // --- Datos Iniciales (Tu lista) ---
        const initialTasks = [
            "Parque de florida", "Alcala 3d", "Neli Bolívar", "Mama diana - agua clara",
            "Villa colombia", "Primo Darío", "Farfán", "Doña leo", "Adriana Palmar",
            "Bello horizonte", "Primo Fabián", "Alexander alameda", "Tascón picacho",
            "Agua clara curaduría", "Escritura familia", "Escritura lote grande", 
            "Postre arroz con leche", "Reciclaje la 14", "Estudios de suelos", 
            "Reclamar documentos planeación", "Tema fundación con Guillermo", 
            "Investigar préstamos posibles para emprendedores",
            "Organizar área de trabajo donde Carlos finca(lo q se va utilizar y no)",
            "conexión eléctrica 220 , hablar tío de Iván", "local el retiro",
            "proyecto hermana (Iván)Neli", "pago de deudas"
        ];
        
        // --- Elementos del DOM ---
        const loginContainer = document.getElementById('loginContainer');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        const appContainer = document.getElementById('appContainer');
        
        const taskList = document.getElementById('taskList');
        const addTaskForm = document.getElementById('addTaskForm');
        const taskInput = document.getElementById('taskInput');
        const loadingEl = document.getElementById('loading');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- Lógica Principal ---

        /**
         * Muestra la aplicación principal o el formulario de login.
         */
        function renderApp(isAuthenticated) {
            if (isAuthenticated) {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                loadingEl.style.display = 'flex'; // Mostrar loading mientras se cargan las tareas
            } else {
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                loadingEl.style.display = 'none';
            }
        }

        /**
         * Muestra mensajes de login (error o éxito).
         */
        function showMessage(message, isError = false) {
            loginMessage.textContent = message;
            loginMessage.style.color = isError ? '#f87171' : '#34d399'; // Rojo para error, verde para éxito
            loginMessage.style.display = 'block';
        }

        /**
         * Maneja el intento de inicio de sesión.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            loginMessage.style.display = 'none';
            loginButton.disabled = true;
            loginButton.textContent = 'Verificando...';

            if (!ALLOWED_EMAILS.includes(email)) {
                showMessage("Acceso denegado. Este correo no está autorizado.", true);
                loginButton.disabled = false;
                loginButton.textContent = 'Ingresar';
                return;
            }

            try {
                // Intento de iniciar sesión con Email/Password
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará de renderizar la app
            } catch (error) {
                console.error("Error de autenticación:", error.code);
                let msg = "Error de inicio de sesión. ";
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    msg += "Verifica la clave o el correo.";
                } else if (error.code === 'auth/invalid-email') {
                    msg += "Formato de correo inválido.";
                } else if (error.code === 'auth/network-request-failed') {
                    msg += "Error de red. Revisa tu conexión.";
                } else if (error.code === 'auth/api-key-not-valid') {
                     msg += "La clave API de Firebase es inválida. Revisa la configuración.";
                } else if (error.code === 'auth/configuration-not-found') {
                     msg += "El inicio de sesión por Correo/Clave no está habilitado en Firebase.";
                } else {
                    msg += "Ocurrió un error inesperado. Revisa la consola.";
                }
                showMessage(msg, true);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Ingresar';
            }
        }


        /**
         * Inicializa Firebase y maneja la autenticación.
         */
        async function initializeAndSignIn() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); 
                setLogLevel('debug');

                onAuthStateChanged(auth, (user) => {
                    if (user && user.email) {
                        // 1. Verificar si el correo está autorizado
                        if (ALLOWED_EMAILS.includes(user.email)) {
                            currentUserId = user.uid;
                            userIdDisplay.textContent = `ID de Usuario: ${currentUserId} | Correo: ${user.email}`;
                            
                            // --- ¡CORRECCIÓN APLICADA AQUÍ! ---
                            // Apuntamos a la colección pública/compartida.
                            const collectionPath = `artifacts/${appId}/public/data/shared_tasks`;
                            tasksCollectionRef = collection(db, collectionPath);
                            
                            renderApp(true); // Mostrar app
                            initializeUserTasksAndListen();
                        } else {
                            // Cierre de sesión por seguridad si el correo no es uno de los permitidos
                            auth.signOut(); 
                            renderApp(false); // Mostrar login
                        }
                    } else {
                        userIdDisplay.textContent = "ID de Usuario: No autenticado.";
                        renderApp(false); // Mostrar login
                    }
                });
                
                // Agregar listener al formulario de login
                loginForm.addEventListener('submit', handleLogin);

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loadingEl.innerHTML = `<p class="text-red-500">Error al conectar con Firebase. Revisa la consola.</p>`;
                if (error.message.includes("Firebase: Error (auth/invalid-api-key)")) {
                    showMessage("Error: La API Key de Firebase es inválida. Revisa la configuración.", true);
                }
            }
        }

        /**
         * Verifica si el usuario tiene tareas, si no, carga la lista inicial.
         * Luego, empieza a escuchar cambios en tiempo real.
         */
        async function initializeUserTasksAndListen() {
            if (!tasksCollectionRef) return; // Salir si la referencia no está definida (login fallido)

            try {
                // 1. Verificar si la colección está vacía
                const q = query(tasksCollectionRef);
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    loadingEl.innerHTML = `<p class="text-gray-400">Importando tu lista de pendientes por primera vez...</p>`;
                    
                    // 2. Si está vacía, cargar las tareas iniciales
                    const batchPromises = [];
                    for (const taskText of initialTasks) {
                        batchPromises.push(addDoc(tasksCollectionRef, {
                            text: taskText,
                            completed: false,
                            createdAt: serverTimestamp(),
                            subtasks: [], 
                            dueDate: null, 
                            updates: [], 
                            files: [] 
                        }));
                    }
                    await Promise.all(batchPromises);
                }

                // 3. Empezar a escuchar cambios en tiempo real
                listenForTasks();

            } catch (error) {
                console.error("Error al inicializar tareas:", error);
                loadingEl.innerHTML = `<p class="text-red-500">Error al cargar tareas.</p>`;
            }
        }

        /**
         * Escucha cambios en la colección de tareas y las renderiza.
         */
        function listenForTasks() {
            if (!tasksCollectionRef) return; // No hacer nada si no hay referencia

            const q = query(tasksCollectionRef);
            
            onSnapshot(q, (snapshot) => {
                let tasksData = [];
                snapshot.forEach((doc) => {
                    tasksData.push({ id: doc.id, ...doc.data() });
                });

                // Ordenar por fecha de creación (cliente)
                tasksData.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeA - timeB;
                });

                renderTasks(tasksData);
                loadingEl.style.display = 'none'; // Ocultar carga
                
            }, (error) => {
                console.error("Error en onSnapshot:", error);
                loadingEl.innerHTML = `<p class="text-red-500">Error al obtener actualizaciones.</p>`;
            });
        }

        /**
         * Formatea una marca de tiempo de Firestore o una cadena ISO a un formato legible.
         */
        function formatTaskDate(dateInput) {
            if (!dateInput) return null;
            let date;
            
            if (dateInput && typeof dateInput.toDate === 'function') {
                // Es un Timestamp de Firestore
                date = dateInput.toDate();
            } 
            else if (typeof dateInput === 'string') {
                // Es una cadena ISO (de un 'new Date().toISOString()')
                date = new Date(dateInput);
            } 
            else if (dateInput instanceof Date) {
                // Ya es un objeto Date
                date = dateInput;
            } else {
                return null; 
            }

            const isISOString = typeof dateInput === 'string';

            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: isISOString ? 'numeric' : undefined, 
                minute: isISOString ? 'numeric' : undefined 
            });
        }

        /**
         * Renderiza la lista de tareas en el DOM.
         */
        function renderTasks(tasks) {
            taskList.innerHTML = ''; // Limpiar lista
            if (tasks.length === 0) {
                taskList.innerHTML = `<p class="text-gray-500 text-center">No hay pendientes. ¡Agrega uno!</p>`;
                return;
            }

            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `bg-gray-800 p-4 rounded-lg shadow-lg transition-all ${task.completed ? 'opacity-60' : ''}`;
                taskEl.setAttribute('data-task-id', task.id);

                const subtasks = task.subtasks || [];
                const completedSubtasks = subtasks.filter(st => st.completed).length;
                const progress = subtasks.length > 0 ? (completedSubtasks / subtasks.length) * 100 : 0;

                // --- Manejo de Fecha de Cumplimiento ---
                const dueDate = task.dueDate; 
                let dueDateHtml = '';
                if (dueDate) {
                    const formattedDate = formatTaskDate(dueDate);
                    const dueDateObj = (dueDate.toDate) ? dueDate.toDate() : new Date(dueDate); 
                    const todayMidnight = new Date(new Date().setHours(0, 0, 0, 0));
                    const isOverdue = !task.completed && dueDateObj < todayMidnight;
                    
                    dueDateHtml = `
                        <div class="flex items-center mt-2 text-xs ${isOverdue ? 'text-red-400 font-semibold' : 'text-gray-400'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span>${isOverdue ? 'Vencido: ' : 'Vence: '} ${formattedDate}</span>
                        </div>
                    `;
                }

                // Renderizar sub-tareas
                const subtasksHtml = subtasks.map(st => `
                    <div class="flex items-center justify-between group py-1 ${st.completed ? 'task-completed' : ''}">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="subtask-${st.id}" 
                                   class="subtask-checkbox form-checkbox h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-600"
                                   data-subtask-id="${st.id}"
                                   ${st.completed ? 'checked' : ''}>
                            <label for="subtask-${st.id}" class="ml-3 text-sm text-gray-300">${st.text}</label>
                        </div>
                        <button class="delete-subtask-btn text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" 
                                data-subtask-id="${st.id}">
                            &times;
                        </button>
                    </div>
                `).join('');

                // --- Renderizar Avances (Updates) ---
                const updates = task.updates || [];
                updates.sort((a, b) => new Date(b.date) - new Date(a.date));

                const updatesHtml = updates.map(up => `
                    <div class="py-2 border-b border-gray-700 last:border-b-0">
                        <p class="text-sm text-gray-200">${up.text}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTaskDate(up.date)}</p>
                    </div>
                `).join('');

                // --- Renderizar Archivos Adjuntos ---
                const files = task.files || [];
                const filesHtml = files.map(file => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(file.name); 
                    const is3DModel = /\.(obj|stl|gltf|glb)$/i.test(file.name);

                    let iconSvg = `
                        <svg class="w-8 h-8 mr-3 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    `;
                    if (isImage) {
                        iconSvg = `<img src="${file.url}" alt="${file.name}" class="w-10 h-10 object-cover rounded-md mr-3 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/4b5563/ffffff?text=IMG';">`;
                    } else if (is3DModel) {
                         iconSvg = `
                            <svg class="w-8 h-8 mr-3 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5l.415-.207a.75.75 0 011.028.16l2.352 3.14a.75.75 0 001.028.16l2.352-3.14a.75.75 0 011.028-.16L17.25 7.5m-8.5-4.5a2.25 2.25 0 114.5 0 2.25 2.25 0 01-4.5 0zM12 21.75l-4.25-5.667a1.5 1.5 0 01-.25-.833V9.75a1.5 1.5 0 011.5-1.5h7.5a1.5 1.5 0 011.5 1.5v5.5a1.5 1.5 0 01-.25.833L12 21.75z" />
                            </svg>
                        `;
                    }


                    return `
                        <div class="flex items-center justify-between group py-1.5 border-b border-gray-700 last:border-b-0">
                            <div class="flex items-center min-w-0">
                                ${iconSvg}
                                <a href="${file.url}" target="_blank" rel="noopener noreferrer" 
                                   class="text-sm text-blue-400 hover:underline truncate" title="${file.name}">
                                    ${file.name}
                                </a>
                            </div>
                            <button class="delete-file-btn text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity ml-2 flex-shrink-0" 
                                    data-file-path="${file.path}"
                                    data-file-url="${file.url}">
                                &times;
                            </button>
                        </div>
                    `;
                }).join('');


                // Renderizar tarjeta de tarea principal
                taskEl.innerHTML = `
                    <!-- Tarea Principal y Fecha -->
                    <div class="flex items-start justify-between">
                        <div class="flex-grow ${task.completed ? 'task-completed' : ''}">
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       id="task-${task.id}" 
                                       class="task-checkbox form-checkbox h-6 w-6 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-600"
                                       ${task.completed ? 'checked' : ''}>
                                <label for="task-${task.id}" class="ml-4 text-xl font-semibold text-gray-100">${task.text}</label>
                            </div>
                            ${dueDateHtml}
                        </div>
                        <button class="delete-task-btn text-gray-500 hover:text-red-400 font-bold text-2xl ml-4 flex-shrink-0">&times;</button>
                    </div>

                    <!-- Progreso de Sub-tareas -->
                    ${subtasks.length > 0 ? `
                    <div class="mt-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs font-medium text-blue-400">Progreso de Actividades</span>
                            <span class="text-xs font-medium text-blue-400">${completedSubtasks} / ${subtasks.length}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Sección de Sub-tareas -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h4 class="text-md font-semibold mb-2 text-gray-400">Actividades</h4>
                        <div class="space-y-2 mb-4">
                            ${subtasksHtml.length > 0 ? subtasksHtml : '<p class="text-xs text-gray-500">Sin actividades aún.</p>'}
                        </div>
                        <form class="addSubtaskForm flex gap-2">
                            <input type="text" 
                                   class="subtask-input flex-grow bg-gray-700 border border-gray-600 text-gray-100 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
                                   placeholder="Nueva actividad..." required>
                            <button type="submit"
                                    class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 font-medium rounded-lg text-xs px-3 py-2 text-center">
                                +
                            </button>
                        </form>
                    </div>

                    <!-- Sección de Avances -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h4 class="text-md font-semibold mb-2 text-gray-400">Avances</h4>
                        <div class="space-y-2 mb-4 max-h-40 overflow-y-auto pr-2">
                            ${updatesHtml.length > 0 ? updatesHtml : '<p class="text-xs text-gray-500">Sin avances registrados.</p>'}
                        </div>
                        <form class="addUpdateForm flex gap-2">
                            <input type="text" 
                                   class="update-input flex-grow bg-gray-700 border border-gray-600 text-gray-100 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
                                   placeholder="Registrar un nuevo avance..." required>
                            <button type="submit"
                                    class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-800 font-medium rounded-lg text-xs px-3 py-2 text-center">
                                Registrar
                            </button>
                        </form>
                    </div>

                    <!-- Sección de Archivos Adjuntos -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h4 class="text-md font-semibold mb-2 text-gray-400">Archivos Adjuntos (Imágenes/Modelos 3D/Documentos)</h4>
                        <div class="space-y-2 mb-4">
                            ${filesHtml.length > 0 ? filesHtml : '<p class="text-xs text-gray-500">Sin archivos. Se guardan en Firebase Storage.</p>'}
                        </div>
                        <!-- Formulario de Subida -->
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="file" 
                                   class="file-input block w-full text-xs text-gray-400 rounded-lg border border-gray-600 bg-gray-700 cursor-pointer focus:outline-none"
                                   required>
                            <button type="button" 
                                    class="upload-file-btn text-white bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:ring-purple-800 font-medium rounded-lg text-xs px-3 py-2 text-center">
                                Subir
                            </button>
                        </div>
                        <!-- Progreso de Subida -->
                        <div class="upload-progress-container mt-2" style="display: none;">
                            <span class="upload-status text-xs text-gray-400">Subiendo...</span>
                            <div class="w-full bg-gray-700 rounded-full h-1.5 mt-1">
                                <div class="upload-progress-bar bg-purple-500 h-1.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
                taskList.appendChild(taskEl);
            });
        }

        // --- Manejadores de Eventos (Event Handlers) ---

        // (CREATE) Agregar un nuevo pendiente principal
        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskText = taskInput.value.trim();
            const dueDateValue = document.getElementById('dueDateInput').value; 
            
            let dueDate = null;
            if (dueDateValue) {
                const [year, month, day] = dueDateValue.split('-').map(Number);
                dueDate = new Date(year, month - 1, day); 
            }

            if (taskText && currentUserId) {
                try {
                    await addDoc(tasksCollectionRef, {
                        text: taskText,
                        completed: false,
                        createdAt: serverTimestamp(),
                        subtasks: [],
                        dueDate: dueDate, // Guardar el objeto Date
                        updates: [],
                        files: [] 
                    });
                    taskInput.value = ''; 
                    document.getElementById('dueDateInput').value = '';
                } catch (error) {
                    console.error("Error al agregar pendiente:", error);
                }
            }
        });

        // Usar delegación de eventos para manejar clics en la lista de tareas
        taskList.addEventListener('click', async (e) => {
            const target = e.target;
            const taskCard = target.closest('[data-task-id]');
            if (!taskCard) return; 
            
            const mainTaskId = taskCard.dataset.taskId;

            // (UPDATE) Marcar/Desmarcar pendiente principal
            if (target.classList.contains('task-checkbox')) {
                try {
                    const docRef = doc(tasksCollectionRef, mainTaskId);
                    await updateDoc(docRef, {
                        completed: target.checked
                    });
                } catch (error) {
                    console.error("Error al actualizar pendiente:", error);
                }
            }

            // (DELETE) Eliminar pendiente principal
            if (target.classList.contains('delete-task-btn')) {
                if (await showCustomConfirm("¿Estás seguro de que quieres eliminar este pendiente y todas sus actividades?")) {
                    try {
                        const docRef = doc(tasksCollectionRef, mainTaskId);
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error al eliminar pendiente:", error);
                    }
                }
            }

            // (UPDATE) Marcar/Desmarcar sub-tarea
            if (target.classList.contains('subtask-checkbox')) {
                const subtaskId = target.dataset.subtaskId;
                const newStatus = target.checked;
                await updateSubtask(mainTaskId, subtaskId, 'toggle', newStatus);
            }

            // (DELETE) Eliminar sub-tarea
            if (target.classList.contains('delete-subtask-btn')) {
                const subtaskId = target.dataset.subtaskId;
                if (await showCustomConfirm("¿Eliminar esta actividad?")) {
                    await updateSubtask(mainTaskId, subtaskId, 'delete');
                }
            }

            // (Handle File Upload)
            if (target.classList.contains('upload-file-btn')) {
                const fileInput = taskCard.querySelector('.file-input');
                const file = fileInput.files ? fileInput.files[0] : null;
                if (!file) {
                    await showCustomConfirm("Por favor, selecciona un archivo primero.", true); 
                    return;
                }
                
                const progressContainer = taskCard.querySelector('.upload-progress-container');
                const progressBar = taskCard.querySelector('.upload-progress-bar');
                const statusText = taskCard.querySelector('.upload-status');
                
                target.disabled = true;
                target.textContent = "Subiendo...";
                
                handleFileUpload(file, mainTaskId, progressContainer, progressBar, statusText, fileInput, target);
            }

            // (Handle File Delete)
            if (target.classList.contains('delete-file-btn')) {
                const filePath = target.dataset.filePath;
                const fileUrl = target.dataset.fileUrl; 
                
                if (await showCustomConfirm("¿Estás seguro de que quieres eliminar este archivo?")) {
                    handleFileDelete(mainTaskId, filePath, fileUrl);
                }
            }
        });

        // (CREATE) Agregar una nueva sub-tarea O un nuevo avance
        taskList.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskCard = e.target.closest('[data-task-id]');
            if (!taskCard) return;

            const mainTaskId = taskCard.dataset.taskId;

            // (CREATE) Agregar una nueva sub-tarea
            if (e.target.classList.contains('addSubtaskForm')) {
                const form = e.target;
                const input = form.querySelector('.subtask-input');
                const subtaskText = input.value.trim();

                if (subtaskText) {
                    try {
                        const newSubtask = {
                            id: crypto.randomUUID(), 
                            text: subtaskText,
                            completed: false
                        };
                        const docRef = doc(tasksCollectionRef, mainTaskId);
                        await updateDoc(docRef, {
                            subtasks: arrayUnion(newSubtask)
                        });
                        input.value = ''; 
                    } catch (error) {
                        console.error("Error al agregar sub-tarea:", error);
                    }
                }
            }

            // (CREATE) Agregar un nuevo avance
            if (e.target.classList.contains('addUpdateForm')) {
                const form = e.target;
                const input = form.querySelector('.update-input');
                const updateText = input.value.trim();

                if (updateText) {
                    try {
                        const newUpdate = {
                            id: crypto.randomUUID(),
                            text: updateText,
                            date: new Date().toISOString() // Usar ISO string para guardar hora/minuto
                        };
                        const docRef = doc(tasksCollectionRef, mainTaskId);
                        await updateDoc(docRef, {
                            updates: arrayUnion(newUpdate)
                        });
                        input.value = ''; 
                    } catch (error) {
                        console.error("Error al agregar avance:", error);
                    }
                }
            }
        });

        /**
         * Lógica para actualizar/eliminar una sub-tarea (requiere leer, modificar y re-escribir el array)
         */
        async function updateSubtask(mainTaskId, subtaskId, action, newStatus = false) {
            const docRef = doc(tasksCollectionRef, mainTaskId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const task = docSnap.data();
                    let newSubtasks = [];

                    if (action === 'toggle') {
                        newSubtasks = task.subtasks.map(st => 
                            st.id === subtaskId ? { ...st, completed: newStatus } : st
                        );
                    } else if (action === 'delete') {
                        newSubtasks = task.subtasks.filter(st => st.id !== subtaskId);
                    }
                    
                    await updateDoc(docRef, {
                        subtasks: newSubtasks
                    });
                }
            } catch (error) {
                console.error("Error al actualizar sub-tarea:", error);
            }
        }

        /**
         * Maneja la subida de un archivo a Firebase Storage
         */
        function handleFileUpload(file, taskId, progressContainer, progressBar, statusText, fileInput, uploadButton) {
            // --- ¡CORRECCIÓN APLICADA AQUÍ! ---
            // Guardamos los archivos en una carpeta pública también, pero organizada por QUIÉN la subió
            const storagePath = `artifacts/${appId}/public/shared_files/${currentUserId}/${taskId}/${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            // Mostrar barra de progreso
            progressContainer.style.display = 'block';

            // Escuchar eventos de subida
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progreso
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                    statusText.textContent = `Subiendo... ${Math.round(progress)}%`;
                },
                (error) => {
                    // Error
                    console.error("Error al subir archivo:", error);
                    statusText.textContent = "Error al subir.";
                    statusText.style.color = '#f87171'; // red-400
                    // Reactivar botón
                    uploadButton.disabled = false;
                    uploadButton.textContent = "Subir";
                },
                async () => {
                    // Completado
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        // Guardar la info del archivo en Firestore
                        const docRef = doc(tasksCollectionRef, taskId);
                        await updateDoc(docRef, {
                            files: arrayUnion({
                                name: file.name,
                                url: downloadURL,
                                path: storagePath 
                            })
                        });

                        // Limpiar UI
                        statusText.textContent = "¡Subido con éxito!";
                        statusText.style.color = '#34d399'; // green-400
                        fileInput.value = ''; // Limpiar el input de archivo
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            statusText.textContent = "Subiendo...";
                            statusText.style.color = 'inherit';
                        }, 2000);
                        
                    } catch (error) {
                        console.error("Error al obtener URL o guardar en Firestore:", error);
                        statusText.textContent = "Error al guardar.";
                        statusText.style.color = '#f87171';
                    } finally {
                        // Reactivar botón
                        uploadButton.disabled = false;
                        uploadButton.textContent = "Subir";
                    }
                }
            );
        }

        /**
         * Maneja la eliminación de un archivo de Storage y Firestore
         */
        async function handleFileDelete(taskId, filePath, fileUrl) {
            // 1. Eliminar de Storage
            const fileRef = ref(storage, filePath);
            try {
                await deleteObject(fileRef);
            } catch (error) {
                console.error("Error al eliminar de Storage:", error);
                if (error.code !== 'storage/object-not-found') {
                     await showCustomConfirm("Error al eliminar el archivo de Storage. La referencia se eliminará de todos modos.", true);
                }
            }

            // 2. Eliminar de Firestore (leyendo, filtrando y escribiendo)
            const docRef = doc(tasksCollectionRef, taskId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const task = docSnap.data();
                    const newFiles = task.files.filter(f => f.url !== fileUrl);
                    await updateDoc(docRef, {
                        files: newFiles
                    });
                }
            } catch (error) {
                console.error("Error al eliminar de Firestore:", error);
                await showCustomConfirm("Error al eliminar la referencia del archivo. Contacta a soporte.", true);
            }
        }


        /**
         * Muestra un modal de confirmación personalizado.
         */
        function showCustomConfirm(message, alertOnly = false) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                
                const modal = document.createElement('div');
                modal.className = 'bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full';
                
                modal.innerHTML = `
                    <p class="text-gray-100 mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="confirmCancel" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" style="${alertOnly ? 'display: none;' : ''}">Cancelar</button>
                        <button id="confirmOk" class="px-4 py-2 rounded-lg ${alertOnly ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-600 hover:bg-red-700'} text-white">
                            ${alertOnly ? 'Aceptar' : 'Confirmar'}
                        </button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // Event listeners
                document.getElementById('confirmOk').onclick = () => {
                    document.body.removeChild(overlay);
                    resolve(true);
                };
                
                if (!alertOnly) {
                    document.getElementById('confirmCancel').onclick = () => {
                        document.body.removeChild(overlay);
                        resolve(false);
                    };
                }
            });
        }


        // --- Iniciar la aplicación ---
        initializeAndSignIn();

    </script>

</body>
</html>





